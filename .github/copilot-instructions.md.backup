# Copilot Instructions — ShiftWork

> **Quick Reference:** For comprehensive documentation, see [WIKI_CONTENT_GUIDE.md](../WIKI_CONTENT_GUIDE.md)

## Big picture architecture
- **Monorepo Structure:** Three primary apps in one repository
  - **ShiftWork.Api** - ASP.NET Core (.NET 8) REST API backend
  - **ShiftWork.Angular** - Angular web app with kiosk mode
  - **ShiftWork.Mobile** - React Native/Expo mobile app
  - **python_client** - Python MCP server for agent utilities
- **Core workflow:** Clock in/out and kiosk answers flow through the API. Kiosk UI calls `GET /api/kiosk/{companyId}/questions` and `POST /api/kiosk/answers`, then creates ShiftEvent records via `POST /api/companies/{companyId}/shiftevents` (see [AGENT.md](../AGENT.md)).
- **Data Layer:** API uses Entity Framework Core with SQL Server, DTOs for API contracts, and AutoMapper for object mapping; controllers in ShiftWork.Api/Controllers call services in ShiftWork.Api/Services (see [README.md](../README.md)).
- **Storage & Auth:** Photo uploads use AWS S3; authentication via Firebase JWT (API validates Firebase tokens; see [AGENT.md](../AGENT.md)).

## Developer workflows (Windows/macOS/Linux)
- **API:** Set environment variables (`DB_CONNECTION_STRING`, Firebase vars), then run `dotnet restore`, `dotnet build`, `dotnet run` in ShiftWork.Api directory (see [AGENT.md](../AGENT.md)).
  - Required env vars: `DB_CONNECTION_STRING`, `FIREBASE_PROJECT_ID`, `FIREBASE_AUTH_DOMAIN`, `FIREBASE_API_KEY`
  - Optional: `WEBHOOK_URL`, `WEBHOOK_SECRET_KEY` for webhook integration
- **Angular:** Run `npm install`, then `npm run start` in ShiftWork.Angular; camera + Wake Lock require HTTPS with a local cert (see [ShiftWork.Angular/README.md](../ShiftWork.Angular/README.md)).
  - For HTTPS: `ng serve --ssl true --ssl-key "./ssl/localhost.key" --ssl-cert "./ssl/localhost.crt"`
  - Required env vars: `API_URL`, Firebase config vars
- **Mobile:** Run `npm install --legacy-peer-deps`, copy `.env.example` to `.env`, configure, then `npm start` in ShiftWork.Mobile directory (see [ShiftWork.Mobile/README.md](../ShiftWork.Mobile/README.md)).
  - Use `npm run ios` or `npm run android` for platform-specific builds
  - Requires `EXPO_PUBLIC_` prefixed env vars
- **Python MCP server:** From python_client directory, create venv, install requirements, and run `python http_mcp_server.py --mode http --port 8080` (see [AGENT.md](../AGENT.md)).

## Project-specific conventions and patterns
- Company-scoped APIs consistently use `/api/companies/{companyId}/...` routes; prefer mirroring this in new endpoints and clients.
- Kiosk flow expects optional PIN verification via `POST /api/auth/verify-pin` before writing ShiftEvents (see [AGENT.md](AGENT.md)).
- DTOs may map between model string IDs and int DTO IDs via AutoMapper (see “ScheduleDto.PersonId” note in [AGENT.md](AGENT.md)).
- Angular kiosk uses Wake Lock and camera; ensure HTTPS in local dev and avoid caching POSTs in PWA (see [ShiftWork.Angular/README.md](ShiftWork.Angular/README.md)).

## Integrations and cross-component details
- **Authentication:** API validates Firebase JWT tokens using Google's public keys with audience/issuer checks; Angular and Mobile read API/Firebase config from environment variables (see [AGENT.md](../AGENT.md)).
- **Mobile Auth State:** Mobile app currently has Firebase Auth disabled with a mock implementation in `config/firebase.ts`; uses direct API calls with static tokens for development (see Known Issues in [ShiftWork.Mobile/README.md](../ShiftWork.Mobile/README.md)).
- **Notifications:** Multi-channel notification service supports SMTP (email), Twilio (SMS), and push notifications; configured via appsettings or environment variables; gracefully falls back to simulation mode when providers not configured (see Notification Service section in [AGENT.md](../AGENT.md)).
- **Webhooks:** Automatic webhook notifications for employee and location changes; uses HMAC SHA256 signatures for verification; configured via `WEBHOOK_URL` and `WEBHOOK_SECRET_KEY` environment variables (see [WEBHOOK_INTEGRATION.md](../WEBHOOK_INTEGRATION.md)).
- **File Storage:** S3 integration for photos; mobile app uploads via signed URLs with Firebase auth headers; kiosk captures photos using browser camera API.

## Reference files and entry points
- **API Entry:** ShiftWork.Api/Program.cs (startup configuration); REST examples in ShiftWork.Api/ShiftWork.Api.http for manual testing.
- **Angular Entry:** ShiftWork.Angular/src/main.ts (bootstrap); routing in ShiftWork.Angular/src/app/app-routing.module.ts.
- **Mobile Entry:** ShiftWork.Mobile/app (Expo Router file-based routing); API services in ShiftWork.Mobile/services; state management in ShiftWork.Mobile/stores.
- **MCP Utilities:** python_client/http_mcp_server.py (MCP server); documentation in python_client/README.txt and python_client/MCP_SERVER.md.

## Key documentation files
- **[AGENT.md](../AGENT.md)** - Complete agent guide with API reference, workflows, and local development setup
- **[README.md](../README.md)** - Project overview and architecture
- **[QUICK_START.md](../QUICK_START.md)** - 5-minute quick start guide for MCP and issues
- **[CONTRIBUTING.md](../CONTRIBUTING.md)** - Contribution guidelines and development workflow
- **[WIKI_CONTENT_GUIDE.md](../WIKI_CONTENT_GUIDE.md)** - Complete wiki structure and content mapping
- **Component READMEs:** ShiftWork.Angular/README.md, ShiftWork.Mobile/README.md, ShiftWork.Mobile/MOBILE_AGENT.md
